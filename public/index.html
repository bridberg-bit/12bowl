<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NFL Pick'em - Family Edition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🏈</text></svg>" />
</head>
<body>
  <div id="app" class="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 p-4">
    <!-- App will load here -->
  </div>

  <script>
    // Configuration - ADD YOUR SHEET ID HERE
    const GOOGLE_SHEET_ID = '1UUehfgNPrP0R4kYBr4zkQ-pJKMlp4i0G-8Zya6N2wdM'; // Replace with your actual Sheet ID
    const GOOGLE_SHEETS_ENABLED = GOOGLE_SHEET_ID !== '1UUehfgNPrP0R4kYBr4zkQ-pJKMlp4i0G-8Zya6N2wdM';
    
    // Kids names
    const kids = ['Brixon', 'Jace', 'Knox', 'Makena', 'Cal', 'Will'];
    
    // App state
    let currentWeek = 1;
    let selectedKid = '';
    let games = [];
    let picks = {};
    let loading = false;
    let lastSyncTime = null;

    // Google Sheets Integration Functions
    async function saveToGoogleSheets(type, data) {
      if (!GOOGLE_SHEETS_ENABLED) {
        console.log('Google Sheets not configured, skipping save');
        return;
      }

      try {
        // For now, we'll save to localStorage and show sync status
        // In a production app, you'd send this to a backend service
        // that can write to Google Sheets via the API
        
        const sheetData = {
          type: type,
          data: data,
          timestamp: new Date().toISOString(),
          week: currentWeek
        };
        
        localStorage.setItem(`sheets-${type}-week${currentWeek}`, JSON.stringify(sheetData));
        lastSyncTime = new Date().toLocaleTimeString();
        
        console.log(`Saved ${type} data for Week ${currentWeek}:`, data);
        
        // Update UI to show sync status
        const syncStatus = document.getElementById('syncStatus');
        if (syncStatus) {
          syncStatus.innerHTML = `📊 Last synced: ${lastSyncTime}`;
          syncStatus.className = 'text-green-600 text-sm';
        }
        
      } catch (error) {
        console.error('Error saving to sheets:', error);
        const syncStatus = document.getElementById('syncStatus');
        if (syncStatus) {
          syncStatus.innerHTML = '❌ Sync failed';
          syncStatus.className = 'text-red-600 text-sm';
        }
      }
    }

    async function loadFromGoogleSheets(sheetName) {
      if (!GOOGLE_SHEETS_ENABLED) {
        return null;
      }

      try {
        // Get the gid for different sheets
        const gidMap = {
          'Schedule': '0',     // First sheet
          'Picks': '1',        // Second sheet  
          'Results': '2'       // Third sheet
        };
        
        const gid = gidMap[sheetName] || '0';
        const url = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/export?format=csv&gid=${gid}`;
        
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const csvText = await response.text();
        const data = parseCSV(csvText);
        
        console.log(`Loaded ${data.length} rows from ${sheetName} sheet`);
        return data;
        
      } catch (error) {
        console.error(`Error loading from ${sheetName} sheet:`, error);
        return null;
      }
    }

    // Simple CSV parser
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      return lines.map(line => {
        // Simple CSV parsing (handles basic cases)
        return line.split(',').map(cell => cell.trim());
      });
    }

    // Save picks with Google Sheets integration
    async function savePicks() {
      // Save to localStorage first
      localStorage.setItem(`week${currentWeek}-picks`, JSON.stringify(picks));
      
      // Save to Google Sheets
      if (GOOGLE_SHEETS_ENABLED) {
        await saveToGoogleSheets('picks', {
          week: currentWeek,
          picks: picks,
          kidCount: Object.keys(picks).length,
          timestamp: new Date().toISOString()
        });
      }
    }

    // Save game results with Google Sheets integration
    async function saveGameResults() {
      if (GOOGLE_SHEETS_ENABLED) {
        const completedGames = games.filter(g => g.completed);
        if (completedGames.length > 0) {
          await saveToGoogleSheets('schedule', {
            week: currentWeek,
            games: completedGames,
            totalGames: games.length,
            completedGames: completedGames.length
          });
        }
      }
    }

    // Save weekly results
    async function saveWeeklyResults() {
      if (GOOGLE_SHEETS_ENABLED) {
        const scores = calculateResults();
        const maxScore = Math.max(...Object.values(scores));
        const winners = Object.keys(scores).filter(kid => scores[kid] === maxScore);
        
        await saveToGoogleSheets('results', {
          week: currentWeek,
          scores: scores,
          winners: winners,
          completedGames: games.filter(g => g.completed).length,
          totalGames: games.length
        });
      }
    }

    // Fetch NFL games from ESPN API
    async function fetchNFLGames(week) {
      loading = true;
      renderApp();
      
      try {
        const response = await fetch(
          `https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard?seasontype=2&week=${week}`
        );
        const data = await response.json();
        
        games = data.events.map(event => {
          const competition = event.competitions[0];
          const homeTeam = competition.competitors.find(team => team.homeAway === 'home');
          const awayTeam = competition.competitors.find(team => team.homeAway === 'away');
          
          const gameDate = new Date(event.date);
          const timeString = gameDate.toLocaleDateString('en-US', { 
            weekday: 'short', 
            month: 'short', 
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            timeZone: 'America/New_York'
          });
          
          const isCompleted = competition.status.type.completed;
          let winner = null;
          if (isCompleted) {
            const homeScore = parseInt(homeTeam.score);
            const awayScore = parseInt(awayTeam.score);
            if (homeScore > awayScore) {
              winner = homeTeam.team.abbreviation;
            } else if (awayScore > homeScore) {
              winner = awayTeam.team.abbreviation;
            }
          }
          
          return {
            id: event.id,
            away: awayTeam.team.abbreviation,
            home: homeTeam.team.abbreviation,
            awayTeam: awayTeam.team.displayName,
            homeTeam: homeTeam.team.displayName,
            time: timeString,
            completed: isCompleted,
            winner: winner,
            homeScore: homeTeam.score,
            awayScore: awayTeam.score,
            tiebreaker: gameDate.getDay() === 1 // Monday games
          };
        });
        
        console.log(`Loaded ${games.length} games for Week ${week}`);
        
        // Save game results to Google Sheets
        await saveGameResults();
        
      } catch (error) {
        console.error('Error fetching games:', error);
        alert('Failed to load games. Please try again.');
      }
      
      loading = false;
      loadPicks();
      renderApp();
    }

    // Load picks from localStorage and Google Sheets
    async function loadPicks() {
      // Load from localStorage first
      const saved = localStorage.getItem(`week${currentWeek}-picks`);
      picks = saved ? JSON.parse(saved) : {};
      
      // Try to load from Google Sheets (for backup/sync)
      if (GOOGLE_SHEETS_ENABLED) {
        try {
          const sheetData = await loadFromGoogleSheets('Picks');
          if (sheetData && sheetData.length > 1) {
            // Parse picks from sheet data
            // This would merge with local picks
            console.log('Loaded picks from Google Sheets:', sheetData.slice(0, 3)); // Show first few rows
          }
        } catch (error) {
          console.warn('Could not load from Google Sheets:', error);
        }
      }
    }

    // Make a pick
    async function makePick(gameId, team) {
      if (!selectedKid) {
        alert('Please select your name first!');
        return;
      }
      
      if (!picks[selectedKid]) picks[selectedKid] = {};
      picks[selectedKid][gameId] = team;
      await savePicks();
      renderApp();
    }

    // Set tiebreaker
    async function setTiebreaker(score) {
      if (!selectedKid) return;
      if (!picks[selectedKid]) picks[selectedKid] = {};
      picks[selectedKid].tiebreaker = score;
      await savePicks();
    }

    // Calculate results
    function calculateResults() {
      const scores = {};
      kids.forEach(kid => {
        scores[kid] = 0;
        if (picks[kid]) {
          games.forEach(game => {
            if (game.completed && picks[kid][game.id] === game.winner) {
              scores[kid]++;
            }
          });
        }
      });
      return scores;
    }

    // Submit picks
    async function submitPicks() {
      if (!selectedKid) {
        alert('Please select your name first!');
        return;
      }
      
      const kidPicks = picks[selectedKid] || {};
      const gameCount = games.length;
      const picksCount = Object.keys(kidPicks).filter(key => key !== 'tiebreaker').length;
      
      if (picksCount < gameCount) {
        alert(`Please make picks for all ${gameCount} games!`);
        return;
      }
      
      const tiebreakerGame = games.find(g => g.tiebreaker);
      if (tiebreakerGame && !kidPicks.tiebreaker) {
        alert('Please enter your tiebreaker score!');
        return;
      }
      
      // Final save to Google Sheets
      await savePicks();
      await saveWeeklyResults();
      
      alert(`Picks submitted for ${selectedKid}! Good luck! 🏈`);
    }

    // Change week
    function changeWeek(newWeek) {
      if (newWeek < 1 || newWeek > 18) return;
      currentWeek = newWeek;
      fetchNFLGames(currentWeek);
    }

    // Render the app (same as before, with sync status added)
    function renderApp() {
      const scores = calculateResults();
      const maxScore = Math.max(...Object.values(scores));
      const winners = Object.keys(scores).filter(kid => scores[kid] === maxScore);
      const completedGames = games.filter(g => g.completed).length;

      document.getElementById('app').innerHTML = `
        <div class="max-w-4xl mx-auto">
          <!-- Header -->
          <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h1 class="text-3xl font-bold text-gray-800">
                🏆 NFL Pick'em - Week ${currentWeek}
              </h1>
              <div class="flex items-center gap-4">
                <button onclick="fetchNFLGames(${currentWeek})" 
                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 ${loading ? 'opacity-50' : ''}">
                  ${loading ? '🔄 Loading...' : '🔄 Refresh'}
                </button>
                ${GOOGLE_SHEETS_ENABLED ? `<span class="text-green-600 text-sm">📊 Sheets Connected</span>` : `<span class="text-orange-600 text-sm">📄 Local Only</span>`}
              </div>
            </div>
            
            ${GOOGLE_SHEETS_ENABLED ? `<div id="syncStatus" class="text-gray-500 text-sm mb-4">${lastSyncTime ? `📊 Last synced: ${lastSyncTime}` : '📊 Ready to sync'}</div>` : ''}
            
            <div class="flex items-center gap-4">
              <span class="text-gray-600">👤</span>
              <select onchange="selectedKid = this.value; renderApp()" 
                      class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="">Select your name...</option>
                ${kids.map(kid => `<option value="${kid}" ${selectedKid === kid ? 'selected' : ''}>${kid}</option>`).join('')}
              </select>
              ${selectedKid ? `<span class="text-green-600 font-semibold">Making picks for ${selectedKid}!</span>` : ''}
            </div>
          </div>

          <!-- Standings (if games completed) -->
          ${completedGames > 0 ? `
          <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">🏆 Week ${currentWeek} Standings</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
              ${kids.map(kid => `
                <div class="border rounded-lg p-4 ${winners.includes(kid) && completedGames > 0 ? 'border-yellow-400 bg-yellow-50' : 'border-gray-200'}">
                  <h3 class="font-bold text-lg">
                    ${kid} ${winners.includes(kid) && completedGames > 0 ? '🏆' : ''}
                  </h3>
                  <p class="text-gray-600">Score: ${scores[kid]} / ${completedGames}</p>
                  ${picks[kid]?.tiebreaker ? `<p class="text-sm text-gray-500">Tiebreaker: ${picks[kid].tiebreaker}</p>` : ''}
                </div>
              `).join('')}
            </div>
          </div>
          ` : ''}

          <!-- Games -->
          <div class="space-y-4">
            ${games.length === 0 && !loading ? `
            <div class="bg-white rounded-lg shadow p-6 text-center">
              <p class="text-gray-600">No games loaded. Click Refresh to load Week ${currentWeek} games.</p>
            </div>
            ` : ''}
            
            ${games.map(game => `
              <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-2">
                    <span class="text-gray-500">📅</span>
                    <span class="text-sm text-gray-600">${game.time}</span>
                    ${game.tiebreaker ? '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs">Tiebreaker Game</span>' : ''}
                  </div>
                  ${game.completed ? `
                    <div class="text-right">
                      <span class="text-green-600 font-semibold">
                        Final: ${game.awayTeam} ${game.awayScore} - ${game.homeScore} ${game.homeTeam}
                      </span>
                      ${game.winner ? `<div class="text-sm text-gray-600">Winner: ${game.winner}</div>` : ''}
                    </div>
                  ` : ''}
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                  <button onclick="makePick('${game.id}', '${game.away}')"
                          ${!selectedKid || game.completed ? 'disabled' : ''}
                          class="p-4 rounded-lg border-2 transition-all ${
                            picks[selectedKid]?.[game.id] === game.away
                              ? 'border-blue-500 bg-blue-50 text-blue-700'
                              : 'border-gray-200 hover:border-gray-300'
                          } ${(!selectedKid || game.completed) ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}">
                    <div class="font-semibold">${game.away}</div>
                    <div class="text-sm text-gray-600">${game.awayTeam}</div>
                    <div class="text-xs text-gray-500">@ ${game.home}</div>
                    ${game.completed ? `<div class="text-lg font-bold">${game.awayScore}</div>` : ''}
                  </button>
                  
                  <button onclick="makePick('${game.id}', '${game.home}')"
                          ${!selectedKid || game.completed ? 'disabled' : ''}
                          class="p-4 rounded-lg border-2 transition-all ${
                            picks[selectedKid]?.[game.id] === game.home
                              ? 'border-blue-500 bg-blue-50 text-blue-700'
                              : 'border-gray-200 hover:border-gray-300'
                          } ${(!selectedKid || game.completed) ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}">
                    <div class="font-semibold">${game.home}</div>
                    <div class="text-sm text-gray-600">${game.homeTeam}</div>
                    <div class="text-xs text-gray-500">vs ${game.away}</div>
                    ${game.completed ? `<div class="text-lg font-bold">${game.homeScore}</div>` : ''}
                  </button>
                </div>
              </div>
            `).join('')}
            
            <!-- Tiebreaker -->
            ${games.find(g => g.tiebreaker) ? `
            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-6">
              <div class="flex items-center gap-2 mb-4">
                <span class="text-yellow-600">🎯</span>
                <h3 class="font-bold text-yellow-800">Tiebreaker</h3>
              </div>
              <p class="text-yellow-700 mb-3">Total points scored in the tiebreaker game:</p>
              <input type="number" 
                     value="${picks[selectedKid]?.tiebreaker || ''}" 
                     onchange="setTiebreaker(this.value)"
                     ${!selectedKid ? 'disabled' : ''}
                     placeholder="Enter total points..."
                     class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500">
            </div>
            ` : ''}
            
            ${selectedKid ? `
            <div class="text-center">
              <button onclick="submitPicks()" 
                      class="px-8 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition-colors">
                Submit Picks for ${selectedKid}
              </button>
            </div>
            ` : ''}
          </div>
          
          <!-- Week Navigation -->
          <div class="flex justify-center mt-8 gap-4">
            <button onclick="changeWeek(${currentWeek - 1})" 
                    ${currentWeek === 1 ? 'disabled' : ''}
                    class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">
              Previous Week
            </button>
            <button onclick="changeWeek(${currentWeek + 1})" 
                    ${currentWeek === 18 ? 'disabled' : ''}
                    class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">
              Next Week
            </button>
          </div>
        </div>
      `;
    }

    // Initialize app
    fetchNFLGames(currentWeek);
  </script>
</body>
</html>
